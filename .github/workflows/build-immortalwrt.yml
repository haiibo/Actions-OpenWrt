#=================================================
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
# Lisence: MIT
# Author: P3TERX
# Blog: https://p3terx.com
#=================================================

name: Build-ImmortalWrt
on:
  # push:
  #   paths: [ immortalwrt_openwrt ]
  # schedule: [ cron: 0 2 */7 * * ]
  # watch:
  #   types: started
  workflow_dispatch:
    inputs:
      branch:
        description: 'ÈÄâÊã©ImmortalWrt‰ªìÂ∫ìÁöÑÂàÜÊîØÔºö'
        default: 'openwrt-21.02'
        required: true
        type: choice
        options: [ openwrt-21.02, openwrt-23.05, master, openwrt-18.06-k5.4, openwrt-18.06 ]

      target:
        description: 'ÈÄâÊã©Ë¶ÅÁîüÊàêÁöÑÊú∫ÂûãÔºö'
        default: 'r1-plus-lts'
        required: true
        type: choice
        options: [ x86_64, r1-plus-lts, newifi-d2, asus_rt-n16, phicomm_k2p, armvirt-64-default, r4s, r2s, r2c ]

      # version:
      #   description: 'ÈÄâÊã©Ë¶ÅÁîüÊàêÁâàÊú¨Ôºö'
      #   default: 'plus'
      #   required: true
      #   type: choice
      #   options: [ pure, plus ]

      ip:
        description: 'ËÆæÁΩÆwebÁôªÂΩïIPÔºö'
        default: '192.168.2.1'
        required: false

      partsize:
        description: 'ËÆæÁΩÆrootfsÂ§ßÂ∞èÔºö'
        default: '800'
        required: false

      free_disk:
        description: 'Êï¥ÁêÜÁ©∫Èó¥'
        type: choice
        default: 'no'
        options: [ 'losetup', 'free-disk-space', 'plus', 'no' ]
        required: false

      depends:
        description: 'ÁºñËØë‰æùËµñÈÄâÈ°π'
        type: choice
        default: 'default'
        options: [ default, ImmortalWrt ]
        required: false

env:
  TZ: Asia/Shanghai
  REPO_FLODER: 'openwrt'
  UPLOAD_RELEASE: true
  UPLOAD_BIN_DIR: true
  UPLOAD_PACKAGES: true
  UPLOAD_SYSUPGRADE: true
  UPLOAD_WETRANSFER: true
  UPLOAD_COWTRANSFER: true

jobs:
  immo-openwrt:
    runs-on: ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id
    name: immortalwrt-${{github.event.inputs.branch}}-${{github.event.inputs.target}}

    permissions:
      contents: write

    env:
      IP: ${{github.event.inputs.ip}}
      DEPENDS: ${{github.event.inputs.depends}}
      # VERSION: ${{github.event.inputs.version}}
      PARTSIZE: ${{github.event.inputs.partsize}}
      REPO_BRANCH: ${{github.event.inputs.branch}}
      FREE_DISK: ${{github.event.inputs.free_disk}}
      TARGET_DEVICE: ${{github.event.inputs.target}}

    # strategy:
    #   fail-fast: false
    #   matrix:
    #     target: ["${{github.event.inputs.target}}"]

    steps:
    - name: Checkout
      uses: actions/checkout@v4.1.2

    - name: jlumbroso Êï¥ÁêÜÁ©∫Èó¥
      continue-on-error: true
      uses: jlumbroso/free-disk-space@main
      if: env.FREE_DISK == 'free-disk-space' || env.FREE_DISK == 'plus'
      with:
        dotnet: true
        android: true
        haskell: true
        tool-cache: true
        swap-storage: true
        large-packages: true

    - name: losetup Êï¥ÁêÜÁ©∫Èó¥
      continue-on-error: true
      if: env.FREE_DISK == 'losetup' || env.FREE_DISK == 'plus'
      run: |
        [ -f /mnt/swapfile ] && sudo swapoff -a && sudo rm -f /mnt/swapfile
        export ROOT_LOOP_BYTES=$((($(df --block-size=1024 --output=avail / | tail -1) - 1024*1024*7) * 1024))
        sudo fallocate -l $ROOT_LOOP_BYTES /root.img
        export ROOT_LOOP_DEVNAME=$(sudo losetup -Pf --show /root.img)
        sudo pvcreate -f $ROOT_LOOP_DEVNAME
        export MNT_LOOP_BYTES=$((($(df --block-size=1024 --output=avail /mnt | tail -1) - 1024*1024*1) * 1024))
        sudo fallocate -l $MNT_LOOP_BYTES /mnt/mnt.img
        export MNT_LOOP_DEVNAME=$(sudo losetup -Pf --show /mnt/mnt.img)
        sudo pvcreate -f $MNT_LOOP_DEVNAME
        sudo vgcreate Actions $ROOT_LOOP_DEVNAME $MNT_LOOP_DEVNAME
        sudo lvcreate -n disk -l 100%FREE Actions
        export LV_DEVNAME=$(sudo lvscan | awk -F "'" '{print $2}')
        sudo mkfs.btrfs -L combinedisk $LV_DEVNAME
        sudo mount -o compress=zstd $LV_DEVNAME $GITHUB_WORKSPACE
        sudo chown -R runner:runner $GITHUB_WORKSPACE
        mkdir -m 0777 -p $GITHUB_WORKSPACE/tmp
        sudo cp -rp /tmp/* $GITHUB_WORKSPACE/tmp || true
        sudo mount -B $GITHUB_WORKSPACE/tmp /tmp

    - name: Á≥ªÁªü‰ø°ÊÅØ
      run: |
        echo "--------------------------CPU‰ø°ÊÅØ--------------------------"
        echo "CPUÁâ©ÁêÜÊï∞ÈáèÔºö$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo -e "CPUÊ†∏ÂøÉ‰ø°ÊÅØÔºö$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo "--------------------------ÂÜÖÂ≠ò‰ø°ÊÅØ--------------------------"
        echo "Â∑≤ÂÆâË£ÖÂÜÖÂ≠òËØ¶ÁªÜ‰ø°ÊÅØÔºö"
        echo -e "$(sudo lshw -short -C memory | grep GiB) \n"
        echo "--------------------------Á£ÅÁõò‰ΩøÁî®ÊÉÖÂÜµ-----------------------"
        echo "Á°¨ÁõòÊï∞ÈáèÔºö$(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
        Emoji=("üéâ" "ü§û" "‚ú®" "üéÅ" "üéà" "üéÑ" "üé®" "üíã" "üçì" "üçï" "üçâ" "üíê" "üå¥" "üöÄ" "üóΩ" "‚õÖ" "üåà" "üî•" "‚õÑ" "üê∂" "üèÖ" "ü¶Ñ" "üê§")
        RANDOM=$$$(date +%s); rand=$[$RANDOM % ${#Emoji[@]}]
        echo "EMOJI=${Emoji[$rand]}" >>$GITHUB_ENV

    - name: ÂÆâË£ÖÁºñËØë‰æùËµñ
      continue-on-error: true
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        if [[ $DEPENDS == 'ImmortalWrt' ]]; then
          wget -qO- is.gd/build_environment | sudo bash
        else
          ( sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 aria2 asciidoc autoconf automake autopoint binutils \
          bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler fastjar flex \
          g++ gawk gcc-multilib gettext git gperf haveged help2man intltool libc6-dev-i386 libelf-dev \
          libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
          libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp nano ninja-build p7zip \
          p7zip-full patch pkgconf python2.7 python3 python3-distutils python3-pyelftools python3-pip \
          python3-ply python3-docutils python3-pyelftools quilt re2c rename rsync scons squashfs-tools \
          subversion swig texinfo uglifyjs unzip upx-ucl vim wget xmlto xxd zip zlib1g-dev
          sudo -E apt-get -qq purge android* azure-cli dotnet* firefox ghc* google* hhvm llvm* mysql* \
          openjdk* php* powershell zulu*
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean ) &
        fi
        sudo -E timedatectl set-timezone "Asia/Shanghai"

    - name: ÈÉ®ÁΩ≤
      continue-on-error: true
      # run: wget -qO- git.io/J6IXO | bash
      run: wget -qO- is.gd/immortalwrt_openwrt | bash

    - name: Cache
      uses: stupidloud/cachewrtbuild@main
      continue-on-error: true
      if: env.CACHE_ACTIONS == 'true'
      with:
        ccache: 'true'
        clean: ${{env.CLEAN}}
        mixkey: ${{env.CACHE_NAME}}
        prefix: ${{github.workspace}}/${{env.REPO_FLODER}}

    - name: tools
      continue-on-error: true
      if: env.CACHE_ACTIONS == 'true' && !cancelled()
      id: tools
      run: cd $REPO_FLODER && make toolchain/compile

    - name: ‰øùÂ≠ò Cache
      id: fetch_cache
      if: (env.FETCH_CACHE == 'true' || steps.tools.conclusion == 'success') && !cancelled()
      run: wget -qO- git.io/lean_openwrt | bash

    - name: Cache ‰∏ä‰º†Âà∞ Release
      continue-on-error: true
      if: steps.fetch_cache.conclusion == 'success' || env.OUTPUT_RELEASE == 'true' && !cancelled()
      uses: softprops/action-gh-release@v2.0.4
      with:
        files: output/*
        token: ${{secrets.GITHUB_TOKEN}}
        body: immortalwrt-Cache
        tag_name: immortalwrt-Cache
        name: ${{env.EMOJI}} immortalwrt-Cache ${{env.EMOJI}}

    - name: ‰∏ãËΩΩËΩØ‰ª∂ÂåÖ
      run: |
        cd $REPO_FLODER
        # make package/download -j16
        n=0; while true; do make package/download -j && break || (n=$((n+1)); [ $n -eq 3 ] && break); done
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Âõ∫‰ª∂ÁºñËØë
      timeout-minutes: 1440
      continue-on-error: true
      id: compile
      run: cd $REPO_FLODER && make -j$(nproc) || make -j1 V=s

    - name: ‰∏ä‰º† Bin
      uses: actions/upload-artifact@v4.3.3
      if: steps.organize.conclusion == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        path: ${{env.REPO_FLODER}}/bin
        name: OpenWrt-${{env.TARGET_DEVICE}}-bin

    - name: Á≠õÈÄâÂõ∫‰ª∂
      id: organize
      if: steps.compile.conclusion == 'success' && !cancelled()
      run: |
        echo "======================="
        echo "Á£ÅÁõò‰ΩøÁî®ÊÉÖÂÜµ:"
        echo "======================="
        df -hT
        cd $REPO_FLODER
        echo "======================="
        du -h --max-depth=1 ./bin
        du -h --max-depth=1 ./build_dir
        du -h --max-depth=1 ./staging_dir
        du -h --max-depth=1 ./ --exclude=bin --exclude=build_dir --exclude=staging_dir --exclude=bin
        ls bin/targets/*/*/
        sf=${CACHE_NAME%%-*}-${REPO_BRANCH#*-}-$(TZ=UTC-8 date +%m-%d)
        ARCH=`awk -F'"' '/ARCH_PACKAGES/{print $2}' .config`
        [[ $FIRMWARE_TYPE ]] && cp -v $(find bin/targets/ -type f -name "*${FIRMWARE_TYPE}*") ../firmware && echo "upload_firmware=true" >>$GITHUB_ENV || true
        tar -zcPf ../firmware/$sf-$ARCH-packages.tar.gz bin/packages/ && echo "upload_packages=true" >>$GITHUB_ENV || true
        cd ../firmware && md5sum * >$sf-$TARGET_DEVICE-md5-config.txt || true
        sed '/^$/d' ../$REPO_FLODER/.config >>$sf-$TARGET_DEVICE-md5-config.txt || true
        echo "FIRMWARE=$PWD" >>$GITHUB_ENV
        echo "STRDATE=$(TZ=UTC-8 date +%Y-%m-%d)" >>$GITHUB_ENV

    - name: ‰∏ä‰º† Packages
      uses: actions/upload-artifact@v4.3.3
      if: env.upload_packages == 'true' && env.UPLOAD_PACKAGES == 'true' && !cancelled()
      with:
        path: firmware/*packages.tar.gz
        name: OpenWrt-${{env.TARGET_DEVICE}}-package

    - name: ‰∏ä‰º† Firmware
      uses: actions/upload-artifact@v4.3.3
      if: env.upload_firmware == 'true' && env.UPLOAD_SYSUPGRADE == 'true' && !cancelled()
      with:
        path: firmware/*${{env.FIRMWARE_TYPE}}*
        name: OpenWrt-${{env.TARGET_DEVICE}}-firmware

    - name: ‰∏ä‰º†Âà∞Â•∂ÁâõÂø´‰º†
      id: cowtransfer
      if: env.upload_firmware == 'true' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh ./transfer cow --block 2621440 -s -p 64 --no-progress $FIRMWARE 2>&1 | tee cowtransfer.log
        echo "::warning file=‚Üì‚ÜìÂ•∂ÁâõÂø´‰º†‰∏ãËΩΩÂú∞ÂùÄ‚Üì‚Üì::$(grep https cowtransfer.log)"

    - name: ‰∏ä‰º†Âà∞ WeTransfer
      id: wetransfer
      if: env.upload_firmware == 'true' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        wget -qO- git.io/file-transfer | sh ./transfer wet -s -p 16 --no-progress $FIRMWARE 2>&1 | tee wetransfer.log
        echo "::warning file=‚Üì‚Üìwetransfer‰∏ãËΩΩÂú∞ÂùÄ‚Üì‚Üì::$(grep https wetransfer.log)"
        pwd

    - name: Firmware ‰∏ä‰º†Âà∞ Release
      if: env.upload_firmware == 'true' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      uses: softprops/action-gh-release@v2.0.4
      with:
        files: firmware/*
        token: ${{secrets.GITHUB_TOKEN}}
        body: immortalwrt-firmware
        tag_name: ${{env.STRDATE}}-immortalwrt
        name: ${{env.EMOJI}} ${{env.STRDATE}} immortalwrt-firmware ${{env.EMOJI}}

    - name: Save cache state
      continue-on-error: true
      if: env.SAVE_CACHE == 'true' && !cancelled()
      run: |
        echo "‰∏ä‰º†Âà∞github"
        export cache_repo_id='654643315'
        export cache_path='github.com/repos/hong0980/OpenWrt-Cache/releases'
        ls output | parallel --wc '
          while true; do
            curl -T {} \
              -H "Content-Type: application/octet-stream" \
              -H "Authorization: token ${{secrets.GITHUB_TOKEN}}" \
              "https://uploads.${cache_path}/${cache_repo_id}/assets?name={}" && break || true
          done'

    - name: Delete Releases
      if: (!cancelled())
      uses: dev-drprasad/delete-older-releases@v0.3.3
      with:
        keep_latest: 15
        delete_tags: true
        delete_tag_pattern: ^.*immortalwrt$
      env:
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
